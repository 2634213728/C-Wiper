# C-Wiperï¼šWindows è½»é‡åŒ–æ¸…ç†ä¸åˆ†æå·¥å…·æ¦‚è¦è®¾è®¡æ–‡æ¡£

**ç‰ˆæœ¬ï¼š** v1.1 (Revised)
**æ—¥æœŸï¼š** 2026-01-31
**æ–‡æ¡£çŠ¶æ€ï¼š** å¾…è¯„å®¡
**ä¿®è®¢è¯´æ˜ï¼š** åŸºäºå®‰å…¨è¯„ä¼°å’Œæ¶æ„è¯„å®¡è¿›è¡Œå¢å¼º

---

## ä¿®è®¢å†å² (Change Log)

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®è®¢å†…å®¹ | ä½œè€… |
|------|------|---------|------|
| v1.0 | 2023-10 | åˆå§‹ç‰ˆæœ¬ | - |
| v1.1 | 2026-01-31 | å¢å¼ºå®‰å…¨è®¾è®¡ã€ç»†åŒ– AppAnalyzer ç®—æ³•ã€è¡¥å……çº¿ç¨‹åŒæ­¥æœºåˆ¶ã€è°ƒæ•´è·¯çº¿å›¾ | - |

---

## 1. å¼•è¨€ (Introduction)

### 1.1 é¡¹ç›®èƒŒæ™¯

Windows ç³»ç»Ÿçš„ C ç›˜éšç€ä½¿ç”¨æ—¶é—´çš„æ¨ç§»ï¼Œä¼šå †ç§¯å¤§é‡ä¸´æ—¶æ–‡ä»¶ã€æ›´æ–°ç¼“å­˜ä»¥åŠåº”ç”¨æ®‹ç•™æ•°æ®ï¼ˆAppDataï¼‰ã€‚ç°æœ‰çš„æ¸…ç†å·¥å…·ï¼ˆå¦‚ CCleanerï¼‰å¾€å¾€ä½“ç§¯åºå¤§ã€åŒ…å«å¹¿å‘Šæˆ–åå°é©»ç•™è¿›ç¨‹ã€‚ç”¨æˆ·æ€¥éœ€ä¸€æ¬¾**ç»¿è‰²ã€å¼€æºã€é€æ˜ä¸”å…·å¤‡å†³ç­–è¾…åŠ©èƒ½åŠ›**çš„è½»é‡åŒ–å·¥å…·ã€‚

### 1.2 æ ¸å¿ƒç›®æ ‡

1. **è½»é‡åŒ– (Lightweight):** å•æ–‡ä»¶æ‰§è¡Œ (EXE)ï¼Œæ— å®‰è£…ï¼Œæ— åå°æœåŠ¡ï¼Œå¯åŠ¨å³ç”¨ï¼Œç”¨å®Œå³èµ°ã€‚
2. **å†³ç­–è¾…åŠ© (Decision Support):** ä¸ä»…ä»…æ˜¯"ä¸€é”®æ¸…ç†"ï¼Œè€Œæ˜¯é€šè¿‡å¯è§†åŒ–çš„åˆ†ææŠ¥å‘Šï¼Œå‘Šè¯‰ç”¨æˆ·"ä»€ä¹ˆå ç”¨äº†ç©ºé—´"ä»¥åŠ"èƒ½å¦å®‰å…¨åˆ é™¤"ã€‚
3. **å®‰å…¨æ€§ (Safety First):** é»˜è®¤æ“ä½œä¸º"ç§»è‡³å›æ”¶ç«™"ï¼Œé…åˆå¤šå±‚é˜²æŠ¤æœºåˆ¶ï¼Œæœç»è¯¯åˆ ç³»ç»Ÿå…³é”®æ–‡ä»¶ã€‚
4. **æ™ºèƒ½åŒ– (Smart Analysis):** é€šè¿‡åº”ç”¨ç©ºé—´å…³è”åˆ†æï¼Œå‘ç°"ç¨‹åºæœ¬ä½“å°ã€ç¼“å­˜ä½“ç§¯å¤§"çš„å¼‚å¸¸åº”ç”¨ã€‚

### 1.3 å·®å¼‚åŒ–å®šä½

ä¸ç°æœ‰å·¥å…·çš„å¯¹æ¯”ï¼š

| ç»´åº¦ | CCleaner | Windows ç£ç›˜æ¸…ç† | **C-Wiper** |
|------|----------|-----------------|------------|
| **ä½“ç§¯** | ~50MB | ç³»ç»Ÿé›†æˆ | **<30MB** |
| **å¹¿å‘Š** | æœ‰ | æ—  | **æ— ï¼ˆå¼€æºï¼‰** |
| **å†³ç­–è¾…åŠ©** | å¼± | æ—  | **å¼ºï¼ˆAppAnalyzerï¼‰** |
| **é€æ˜åº¦** | é—­æº | ç³»ç»Ÿå·¥å…· | **å®Œå…¨å¼€æº** |
| **åº”ç”¨å…³è”åˆ†æ** | æ—  | æ—  | **âœ… ç‹¬æœ‰åŠŸèƒ½** |

---

## 2. ç³»ç»Ÿæ¶æ„ (System Architecture)

é‡‡ç”¨ **MVC (Model-View-Controller)** å˜ä½“æ¶æ„ï¼Œå®ç°ç•Œé¢å±•ç¤ºä¸åº•å±‚é€»è¾‘çš„è§£è€¦ã€‚

### 2.1 æŠ€æœ¯æ ˆ (Tech Stack)

* **å¼€å‘è¯­è¨€:** Python 3.10+
* **GUI æ¡†æ¶:**
  * **æ ‡å‡†ç‰ˆ:** Tkinter (Python åŸç”Ÿï¼Œä½“ç§¯æœ€å°)
  * **ç¾è§‚ç‰ˆ:** CustomTkinter (å¯é€‰ï¼Œå¢åŠ  ~5-10MB)
* **æ ¸å¿ƒåº“:**
  * `pathlib`: ç°ä»£åŒ–æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼ˆæ›¿ä»£ `os.path`ï¼‰
  * `send2trash`: å®ç°å®‰å…¨åˆ é™¤ï¼ˆç§»å…¥å›æ”¶ç«™ï¼‰
  * `ctypes`: è°ƒç”¨ Windows API (ç®¡ç†å‘˜æƒé™æ£€æµ‹ã€DPI é€‚é…)
  * `threading` + `queue`: å¤šçº¿ç¨‹æ‰«æä¸çº¿ç¨‹é—´é€šä¿¡
  * `difflib`: å­—ç¬¦ä¸²ç›¸ä¼¼åº¦è®¡ç®—ï¼ˆAppAnalyzerï¼‰
* **æ„å»ºå·¥å…·:** Nuitka (ç¼–è¯‘ä¸º C ä»£ç ï¼Œå®ç°é«˜æ€§èƒ½ä¸æå°ä½“ç§¯)
* **é…ç½®å­˜å‚¨:** JSON (è§„åˆ™åº“ã€ç™½åå•ã€åˆ«åæ˜ å°„)

### 2.2 æ¶æ„åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   View Layer                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚Dashboard â”‚  â”‚ Cleaner  â”‚  â”‚ Analyzer â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Controller Layer                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ScanControllerâ”‚  â”‚CleanControllerâ”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚    Thread Manager & Queue        â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Model Layer                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚Scanner   â”‚  â”‚RuleEngineâ”‚  â”‚AppAnalyzerâ”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚Cleaner   â”‚  â”‚Security  â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 çº¿ç¨‹åŒæ­¥æœºåˆ¶

**è®¾è®¡åŸåˆ™ï¼š** æ‰«æä¸æ¸…ç†äº’æ–¥ï¼Œé¿å…èµ„æºå†²çª

```python
class StateManager:
    """çº¿ç¨‹å®‰å…¨çš„çŠ¶æ€ç®¡ç†å™¨"""

    def __init__(self):
        self.state = "idle"  # idle, scanning, cleaning
        self.lock = threading.Lock()
        self.scan_queue = queue.Queue()
        self.cancel_flag = False

    def start_scan(self):
        with self.lock:
            if self.state != "idle":
                raise RuntimeError(f"å½“å‰çŠ¶æ€ä¸º {self.state}ï¼Œæ— æ³•å¯åŠ¨æ‰«æ")
            self.state = "scanning"
            self.cancel_flag = False

    def start_clean(self):
        with self.lock:
            if self.state != "idle":
                raise RuntimeError(f"å½“å‰çŠ¶æ€ä¸º {self.state}ï¼Œæ— æ³•å¯åŠ¨æ¸…ç†")
            self.state = "cleaning"

    def finish(self):
        with self.lock:
            self.state = "idle"
```

---

## 3. åŠŸèƒ½æ¨¡å—è®¾è®¡ (Functional Modules)

ç³»ç»Ÿä¸»è¦ç”±äº”å¤§åŠŸèƒ½æ¨¡å—ç»„æˆï¼š

### 3.1 æ ¸å¿ƒæ‰«ææ¨¡å— (Core Scanner)

**3.1.1 æ‰«æç­–ç•¥ï¼šé¶ç‚¹æ‰«æ (Targeted Scan)**

ä¸è¿›è¡Œå…¨ç›˜ç›²æ‰«ï¼ŒåŸºäºé¢„è®¾çš„é«˜é¢‘åƒåœ¾è·¯å¾„åˆ—è¡¨è¿›è¡Œç²¾å‡†æ‰“å‡»ã€‚

**é»˜è®¤æ‰«æç›®æ ‡ï¼š**
| ç±»åˆ« | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| ç”¨æˆ·ä¸´æ—¶æ–‡ä»¶ | `%TEMP%` | å½“å‰ç”¨æˆ·ä¸´æ—¶ç›®å½• |
| ç³»ç»Ÿä¸´æ—¶æ–‡ä»¶ | `C:\Windows\Temp` | ç³»ç»Ÿçº§ä¸´æ—¶æ–‡ä»¶ï¼ˆéœ€ç®¡ç†å‘˜æƒé™ï¼‰ |
| æµè§ˆå™¨ç¼“å­˜ | `%LOCALAPPDATA%\Google\Chrome\User Data\Default\Cache` | Chrome ç¼“å­˜ |
| æ›´æ–°ç¼“å­˜ | `C:\Windows\SoftwareDistribution\Download` | Windows æ›´æ–°æ®‹ç•™ |
| ç¼©ç•¥å›¾ç¼“å­˜ | `%LOCALAPPDATA%\Microsoft\Windows\Explorer` | ç¼©ç•¥å›¾æ•°æ®åº“ |
| å›æ”¶ç«™ | `C:\$Recycle.Bin` | å›æ”¶ç«™å†…å®¹ï¼ˆéœ€ç®¡ç†å‘˜æƒé™ï¼‰ |

**3.1.2 å¤šçº¿ç¨‹å¤„ç†**

* æ‰«æè¿‡ç¨‹åœ¨ç‹¬ç«‹çº¿ç¨‹è¿è¡Œï¼Œä¸»çº¿ç¨‹è´Ÿè´£ UI åˆ·æ–°ï¼ˆè¿›åº¦æ¡ã€çŠ¶æ€æ–‡æœ¬ï¼‰
* ä½¿ç”¨ `queue.Queue` è¿›è¡Œçº¿ç¨‹é—´æ•°æ®ä¼ é€’
* æ”¯æŒæ‰«æä¸­é€”å–æ¶ˆï¼ˆé€šè¿‡ `cancel_flag` æ£€æŸ¥ï¼‰

**3.1.3 æ€§èƒ½ä¼˜åŒ–**

* **æ–¹æ¡ˆ Aï¼ˆä¼˜å…ˆï¼‰ï¼š** ä½¿ç”¨ Windows API (`FindFirstFile/FindNextFile`) é€šè¿‡ `ctypes` è°ƒç”¨ï¼Œæ¯” Python `os.walk` å¿« 5-10 å€
* **æ–¹æ¡ˆ Bï¼ˆå¤‡é€‰ï¼‰ï¼š** ä½¿ç”¨ `pathlib.Path.rglob()` + å¹¶å‘æ‰«æï¼ˆé’ˆå¯¹å¤šä¸ªç‹¬ç«‹ç›®å½•ï¼‰

### 3.2 è§„åˆ™å†³ç­–å¼•æ“ (Rule Engine)

**3.2.1 é£é™©åˆ†çº§ç³»ç»Ÿ**

| çº§åˆ« | æ ‡è¯† | ç¤ºä¾‹ | é»˜è®¤çŠ¶æ€ | å¯åˆ é™¤æ€§ |
|------|------|------|---------|---------|
| **L1 (Safe)** | ğŸŸ¢ | `.tmp`, `.log`, æµè§ˆå™¨ç¼“å­˜ | âœ… é»˜è®¤å‹¾é€‰ | å¯å®‰å…¨åˆ é™¤ |
| **L2 (Review)** | ğŸŸ¡ | ä¸‹è½½ç›®å½•ã€å¤§æ–‡ä»¶ã€æœªçŸ¥åº”ç”¨æ•°æ® | âŒ é»˜è®¤ä¸å‹¾é€‰ | éœ€äººå·¥ç¡®è®¤ |
| **L3 (System)** | ğŸ”´ | ç³»ç»Ÿæ ¸å¿ƒæ–‡ä»¶ã€ç¨‹åºç›®å½• | âŒ ä»…æ˜¾ç¤ºï¼Œç¦æ­¢å‹¾é€‰ | ä¸å¯åˆ é™¤ |

**3.2.2 å¢å¼ºè§„åˆ™åº“è®¾è®¡**

```json
{
  "version": "1.1",
  "scan_targets": [
    {
      "id": "user_temp",
      "name": "ç”¨æˆ·ä¸´æ—¶æ–‡ä»¶",
      "path": "%TEMP%",
      "risk": 0,
      "description": "ç³»ç»Ÿè¿è¡Œæ—¶äº§ç”Ÿçš„ä¸´æ—¶æ•°æ®ï¼Œå¯å®‰å…¨åˆ é™¤ã€‚",
      "conditions": {
        "age_filter": "older_than_7_days",
        "exclude_extensions": [".docx", ".xlsx", ".pptx", ".pdf"],
        "size_filter": "all"
      }
    },
    {
      "id": "chrome_cache",
      "name": "Chrome ç¼“å­˜",
      "path": "%LOCALAPPDATA%\\Google\\Chrome\\User Data\\Default\\Cache",
      "risk": 0,
      "conditions": {
        "age_filter": "all",
        "size_filter": "larger_than_1MB"
      }
    }
  ],
  "whitelist_extensions": [".docx", ".xlsx", ".pdf", ".key", ".doc", ".ppt"],
  "protected_paths": [
    "C:\\Windows\\System32",
    "C:\\Windows\\SysWOW64",
    "C:\\Program Files",
    "C:\\Program Files (x86)",
    "C:\\Windows\\System32\\drivers"
  ],
  "app_aliases": {
    "wechat": ["å¾®ä¿¡", "wechat files", "weixin", "tencent/wechat"],
    "chrome": ["google chrome", "è°·æ­Œæµè§ˆå™¨"],
    "edge": ["microsoft edge", "å¾®è½¯æµè§ˆå™¨"]
  }
}
```

**3.2.3 è§„åˆ™åŒ¹é…ä¼˜åŒ–**

ä½¿ç”¨å­—å…¸ç´¢å¼•é¿å…æ¯ä¸ªæ–‡ä»¶éå†æ‰€æœ‰è§„åˆ™ï¼š

```python
class RuleIndex:
    """è§„åˆ™ç´¢å¼•å™¨ï¼Œæå‡åŒ¹é…æ•ˆç‡"""

    def __init__(self, rules):
        self.path_rules = {}  # {parent_path: [rules]}
        self.ext_rules = {}   # {extension: [rules]}

        for rule in rules:
            parent = os.path.dirname(rule['path'])
            self.path_rules.setdefault(parent, []).append(rule)

    def find_match(self, file_path):
        """å¿«é€ŸæŸ¥æ‰¾åŒ¹é…è§„åˆ™"""
        parent = os.path.dirname(file_path)
        return self.path_rules.get(parent, [])
```

### 3.3 åº”ç”¨ç©ºé—´åˆ†æå™¨ (AppAnalyzer) - *[é‡ç‚¹ç‰¹æ€§]*

**3.3.1 æ ¸å¿ƒä»·å€¼**

* **ç©ºé—´é»‘æ´è¯†åˆ«ï¼š** è§£å†³"æ˜æ˜å¸è½½äº†è½¯ä»¶ï¼ŒC ç›˜è¿˜æ˜¯æ»¡"çš„ç—›ç‚¹
* **æ•°æ®å¥åº·åº¦è¯„ä¼°ï¼š** é€šè¿‡ `data_size/program_size` æ¯”å€¼è¯†åˆ«å¼‚å¸¸åº”ç”¨
* **å¸è½½å†³ç­–è¾…åŠ©ï¼š** ç”¨æˆ·å¯çœ‹åˆ°"å¾®ä¿¡åªå  300MB ä½†ç¼“å­˜å  15GB"ï¼Œå†³å®šæ˜¯å¦æ¸…ç†

**3.3.2 æ‰«æåŒºåŸŸ**

1. **Static Zone (æœ¬ä½“):** `C:\Program Files`, `C:\Program Files (x86)`
2. **Dynamic Zone (æ•°æ®):** `%LOCALAPPDATA%`, `%APPDATA%`

**3.3.3 æ™ºèƒ½åŒ¹é…ç®—æ³•**

```python
class AppMatcher:
    """åº”ç”¨åç§°åŒ¹é…å™¨"""

    # å¸¸è§åˆ«åæ˜ å°„
    ALIAS_MAP = {
        "wechat": ["å¾®ä¿¡", "wechat files", "weixin"],
        "chrome": ["google chrome", "è°·æ­Œæµè§ˆå™¨"],
        "edge": ["microsoft edge", "å¾®è½¯æµè§ˆå™¨"],
    }

    @staticmethod
    def normalize_name(name):
        """æ ‡å‡†åŒ–åº”ç”¨åç§°"""
        name = name.lower().strip()
        # ç§»é™¤å¸¸è§åç¼€
        for suffix in [" files", " data", " cache", "ï¼ˆx86ï¼‰", " (x86)"]:
            if name.endswith(suffix):
                name = name[:-len(suffix)]
        return name

    @staticmethod
    def similarity(str1, str2):
        """è®¡ç®—å­—ç¬¦ä¸²ç›¸ä¼¼åº¦ (0-1)"""
        from difflib import SequenceMatcher
        return SequenceMatcher(None, str1, str2).ratio()

    @classmethod
    def match(cls, static_name, dynamic_name):
        """åˆ¤æ–­ä¸¤ä¸ªç›®å½•åæ˜¯å¦å±äºåŒä¸€åº”ç”¨"""
        s_norm = cls.normalize_name(static_name)
        d_norm = cls.normalize_name(dynamic_name)

        # 1. ç²¾ç¡®åŒ¹é…
        if s_norm == d_norm:
            return True, 1.0

        # 2. åˆ«ååŒ¹é…
        for app, aliases in cls.ALIAS_MAP.items():
            if s_norm in aliases and d_norm in aliases:
                return True, 0.95

        # 3. æ¨¡ç³ŠåŒ¹é…ï¼ˆé˜ˆå€¼ 0.7ï¼‰
        sim = cls.similarity(s_norm, d_norm)
        if sim > 0.7:
            return True, sim

        return False, 0
```

**3.3.4 è¾“å‡ºå¯¹è±¡**

```python
class AppCluster:
    """åº”ç”¨ç°‡å¯¹è±¡"""
    name: str           # e.g., "Tencent"
    program_size: int   # e.g., 500 MB
    data_size: int      # e.g., 15 GB
    ratio: float        # data_size / program_size
    confidence: float   # åŒ¹é…ç½®ä¿¡åº¦ (0-1)
    suggestion: str     # "å»ºè®®ä½¿ç”¨åº”ç”¨å†…æ¸…ç†"

    def get_risk_level(self):
        """æ ¹æ®æ•°æ®/ç¨‹åºæ¯”ä¾‹è¯„ä¼°é£é™©"""
        if self.ratio > 10:
            return "critical"  # ä¸¥é‡å¼‚å¸¸
        elif self.ratio > 5:
            return "warning"   # éœ€è¦å…³æ³¨
        else:
            return "normal"    # æ­£å¸¸èŒƒå›´
```

**3.3.5 å­¤å„¿æ•°æ®è¯†åˆ«**

è‹¥ Dynamic Zone å­˜åœ¨å·¨å¤§æ–‡ä»¶å¤¹ä½†åœ¨ Static Zone æ— å¯¹åº”ï¼ˆä¸”éç³»ç»Ÿç›®å½•ï¼‰ï¼Œæ ‡è®°ä¸º"å¯èƒ½çš„å¸è½½æ®‹ç•™"ï¼š

```python
# ç¤ºä¾‹ï¼šç”¨æˆ·å¸è½½äº† Photoshopï¼Œä½† AppData ä»æœ‰ç¼“å­˜
# Static Zone: æ—  Adobe ç›®å½•
# Dynamic Zone: Adobe\Photoshop\Cache (2.5GB)
# è¯†åˆ«ç»“æœ: å­¤å„¿æ•°æ®ï¼Œå»ºè®®æ¸…ç†
```

### 3.4 æ¸…ç†æ‰§è¡Œå™¨ (Cleaner Executor)

**3.4.1 æ‰§è¡Œæµç¨‹**

1. **ç”¨æˆ·é€‰æ‹© â†’ 2. é¢„è§ˆæ±‡æ€» â†’ 3. åŒé‡ç¡®è®¤ â†’ 4. æ‰§è¡Œåˆ é™¤ â†’ 5. ç»“æœæŠ¥å‘Š**

**3.4.2 åŒé‡ç¡®è®¤æœºåˆ¶**

* **ç¬¬ä¸€æ¬¡ç¡®è®¤ï¼š** åœ¨ç‚¹å‡»"æ¸…ç†"æŒ‰é’®åï¼Œæ˜¾ç¤ºæ±‡æ€»å¼¹çª—
  ```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ âš ï¸ ç¡®è®¤æ¸…ç†                      â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ æ–‡ä»¶æ•°é‡ï¼š15,234 ä¸ª             â”‚
  â”‚ é¢„è®¡é‡Šæ”¾ï¼š7.3 GB                â”‚
  â”‚                                 â”‚
  â”‚ âš ï¸ æ³¨æ„ï¼šæ–‡ä»¶å°†è¢«ç§»è‡³å›æ”¶ç«™      â”‚
  â”‚ å¦‚éœ€æ°¸ä¹…é‡Šæ”¾ç©ºé—´ï¼Œè¯·æ¸…ç©ºå›æ”¶ç«™   â”‚
  â”‚                                 â”‚
  â”‚ [ç¡®è®¤æ¸…ç†] [å–æ¶ˆ]               â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ```

* **ç¬¬äºŒæ¬¡ç¡®è®¤ï¼š** æ£€æŸ¥å›æ”¶ç«™å®¹é‡æ˜¯å¦è¶³å¤Ÿï¼ˆå‚è§ 6.3.2ï¼‰

**3.4.3 å®¹é”™å¤„ç†**

| å¼‚å¸¸ç±»å‹ | å¤„ç†ç­–ç•¥ | ç”¨æˆ·æç¤º |
|---------|---------|---------|
| `PermissionError` | è·³è¿‡æ–‡ä»¶ï¼Œè®°å½•æ—¥å¿— | é™é»˜å¤„ç† |
| `FileInUse` | è·³è¿‡æ–‡ä»¶ï¼Œè®°å½•æ—¥å¿— | é™é»˜å¤„ç† |
| `ReadOnly` | å°è¯•ç§»é™¤åªè¯»å±æ€§åé‡è¯• | é™é»˜å¤„ç† |
| `RecycleBinFull` | æä¾›é€‰é¡¹ï¼ˆåˆ†æ‰¹/æ°¸ä¹…åˆ é™¤/å–æ¶ˆï¼‰ | å¼¹çª—è¯¢é—® |

**3.4.4 æ¸…ç†æŠ¥å‘Š**

æ¸…ç†å®Œæˆåæ˜¾ç¤ºè¯¦ç»†æŠ¥å‘Šï¼š

```json
{
  "timestamp": "2026-01-31T15:30:00",
  "duration_seconds": 45,
  "summary": {
    "files_deleted": 15234,
    "files_failed": 3,
    "space_freed": 7300000000,
    "space_freed_human": "7.3 GB"
  },
  "errors": [
    {
      "path": "C:\\temp\\locked_file.dat",
      "error": "PermissionError",
      "action": "skipped"
    }
  ]
}
```

### 3.5 å®‰å…¨æ¨¡å— (Security Layer) *[æ–°å¢]*

**3.5.1 å¤šå±‚é˜²æŠ¤æœºåˆ¶**

```python
class SecurityLayer:
    """å¤šå±‚å®‰å…¨é˜²æŠ¤"""

    # ç¬¬ä¸€å±‚ï¼šç¡¬ç¼–ç ä¿æŠ¤è·¯å¾„ï¼ˆä¸å¯ç¯¡æ”¹ï¼‰
    HARDCODED_PROTECTED = [
        "C:\\Windows",
        "C:\\Program Files",
        "C:\\Program Files (x86)",
        "C:\\ProgramData",
    ]

    # ç¬¬äºŒå±‚ï¼šç³»ç»Ÿæ–‡ä»¶è¯†åˆ«
    SYSTEM_FILES = [
        "pagefile.sys",
        "hiberfil.sys",
        "swapfile.sys",
        "bootmgr",
    ]

    @classmethod
    def is_safe_to_delete(cls, path, rules):
        """ç»¼åˆåˆ¤æ–­è·¯å¾„æ˜¯å¦å¯å®‰å…¨åˆ é™¤"""

        # æ£€æŸ¥ 1ï¼šç¡¬ç¼–ç è·¯å¾„ä¿æŠ¤
        real_path = os.path.realpath(path)  # è§£æç¬¦å·é“¾æ¥
        for protected in cls.HARDCODED_PROTECTED:
            if real_path.startswith(protected):
                return False, "å—ä¿æŠ¤è·¯å¾„"

        # æ£€æŸ¥ 2ï¼šç³»ç»Ÿæ–‡ä»¶ä¿æŠ¤
        filename = os.path.basename(path).lower()
        if filename in cls.SYSTEM_FILES:
            return False, "ç³»ç»Ÿå…³é”®æ–‡ä»¶"

        # æ£€æŸ¥ 3ï¼šçœŸå®æ‰©å±•åæ£€æµ‹ï¼ˆé˜² .exe.pdf ç»•è¿‡ï¼‰
        real_ext = cls.get_real_extension(path)
        if real_ext in rules.get('whitelist_extensions', []):
            return False, "å—ä¿æŠ¤æ‰©å±•å"

        return True, "OK"

    @staticmethod
    def get_real_extension(path):
        """é€šè¿‡æ–‡ä»¶é­”æ•°æ£€æµ‹çœŸå®ç±»å‹"""
        magic_numbers = {
            b'PK\x03\x04': '.zip',
            b'\x25\x50\x44\x46': '.pdf',
            b'\xd0\xcf\x11\xe0': '.doc',
            b'MZ': '.exe',  # PE å¯æ‰§è¡Œæ–‡ä»¶
        }

        try:
            with open(path, 'rb') as f:
                header = f.read(4)
            for magic, ext in magic_numbers.items():
                if header.startswith(magic):
                    return ext
        except:
            pass

        return os.path.splitext(path)[1]
```

**3.5.2 TOCTOU é˜²æŠ¤**

é˜²æ­¢ Time-of-Check-Time-of-Use æ”»å‡»ï¼š

```python
def safe_delete(path):
    """åŸå­æ€§å®‰å…¨åˆ é™¤"""
    # è§£æç¬¦å·é“¾æ¥ï¼ˆé˜²æ­¢æ”»å‡»è€…åœ¨æ£€æŸ¥ååˆ›å»ºé“¾æ¥ï¼‰
    real_path = os.path.realpath(path)

    # æœ€åä¸€é“é˜²æŠ¤ï¼ˆå³ä½¿è§„åˆ™åº“è¢«ç¯¡æ”¹ä¹Ÿæœ‰æ•ˆï¼‰
    if any(real_path.startswith(p) for p in SecurityLayer.HARDCODED_PROTECTED):
        raise SecurityError(f"æ‹’ç»åˆ é™¤å—ä¿æŠ¤è·¯å¾„: {path}")

    # å¤„ç†åªè¯»æ–‡ä»¶
    if os.path.isfile(path) and not os.access(path, os.W_OK):
        os.chmod(path, 0o777)

    # ç§»è‡³å›æ”¶ç«™
    send2trash(path)
```

---

## 4. UI/UX è®¾è®¡ (User Interface)

ç•Œé¢é‡‡ç”¨å•çª—å£å¸ƒå±€ï¼Œåˆ†ä¸ºä¸‰ä¸ªä¸»è¦çŠ¶æ€ã€‚

### 4.1 ä»ªè¡¨ç›˜ (Dashboard)

* **è§†è§‰ä¸­å¿ƒï¼š** ä¸€ä¸ªç¯å½¢è¿›åº¦æ¡ï¼Œæ˜¾ç¤º C ç›˜å½“å‰ä½¿ç”¨ç‡
* **æ“ä½œï¼š** å·¨å¤§çš„ "å¼€å§‹åˆ†æ" æŒ‰é’®
* **æ¨¡å¼æŒ‡ç¤ºå™¨ï¼š** æ˜ç¡®æ˜¾ç¤ºå½“å‰è¿è¡Œæ¨¡å¼
  ```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ğŸ›¡ï¸ å½“å‰æ¨¡å¼ï¼šæ ‡å‡†æ¨¡å¼            â”‚
  â”‚    (ä»…æ¸…ç†ç”¨æˆ·ä¸´æ—¶æ–‡ä»¶)          â”‚
  â”‚    æç¤ºï¼šå³é”®"ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ"  â”‚
  â”‚    å¯å¯ç”¨é«˜çº§æ¨¡å¼                â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ```

### 4.2 åˆ†ææŠ¥å‘Šé¡µ (Analysis Report)

æ‰«æå®Œæˆåè‡ªåŠ¨è·³è½¬è‡³æ­¤é¡µï¼ŒåŒ…å«ä¸¤ä¸ªæ ‡ç­¾é¡µ (Tab)ï¼š

**4.2.1 Tab 1: åƒåœ¾æ¸…ç† (Trash Cleaner)**

* Treeview åˆ—è¡¨ï¼ŒæŒ‰ç±»åˆ«åˆ†ç»„ï¼ˆç³»ç»Ÿåƒåœ¾ã€æµè§ˆå™¨ç¼“å­˜ï¼‰
* æ¯è¡ŒåŒ…å«ï¼šå¤é€‰æ¡† | ç±»åˆ« | è·¯å¾„ | å¤§å° | é£é™©é¢œè‰²æ ‡ç­¾
* åº•éƒ¨ï¼šæ¸…ç†æŒ‰é’®ï¼ˆæ˜¾ç¤ºé¢„è®¡é‡Šæ”¾ç©ºé—´ï¼‰
* **å¢å¼ºåŠŸèƒ½ï¼š**
  * æ”¯æŒæŒ‰é£é™©ç­‰çº§ç­›é€‰
  * æ”¯æŒæŒ‰å¤§å°æ’åº
  * å³é”®èœå•ï¼š[æ‰“å¼€æ–‡ä»¶ä½ç½®] [å±æ€§] [æ’é™¤æ­¤è·¯å¾„]

**4.2.2 Tab 2: åº”ç”¨æ´å¯Ÿ (App Insights)**

* **Top 10 å ç”¨æ’è¡Œï¼š** å †å æ¡å½¢å›¾ï¼ˆè“è‰²=ç¨‹åºï¼Œçº¢è‰²=æ•°æ®ï¼‰
* **å¼‚å¸¸æç¤ºï¼š** é«˜äº®æ˜¾ç¤ºæ•°æ®ä½“ç§¯ > ç¨‹åºä½“ç§¯ 5 å€çš„åº”ç”¨
* **æ“ä½œï¼š** ä¸æä¾›ç›´æ¥åˆ é™¤ï¼Œè€Œæ˜¯æä¾›å¼•å¯¼æ“ä½œ
  * [æ‰“å¼€ AppData æ–‡ä»¶å¤¹] æŒ‰é’®
  * [æ‰“å¼€ç¨‹åºå®˜ç½‘] æŒ‰é’®ï¼ˆå¦‚ Chrome çš„æ¸…ç†è¯´æ˜ï¼‰
  * æ™ºèƒ½å»ºè®®ï¼š`"å»ºè®®ä½¿ç”¨ Chrome å†…ç½®æ¸…ç†åŠŸèƒ½ (Ctrl+Shift+Delete)"`

### 4.3 æ‰«æè¿›åº¦é¡µ (Scanning Progress)

* **å®æ—¶è¿›åº¦ï¼š** è¿›åº¦æ¡ + ç™¾åˆ†æ¯”
* **å½“å‰çŠ¶æ€ï¼š** "æ­£åœ¨æ‰«æ: C:\Users\xxx\AppData\Local\Google\Chrome..."
* **å·²å‘ç°ï¼š** "1,234 ä¸ªæ–‡ä»¶ï¼Œæ€»è®¡ 2.3 GB"
* **æ“ä½œï¼š** [å–æ¶ˆæ‰«æ] æŒ‰é’®

### 4.4 æ¸…ç†ç»“æœé¡µ (Clean Result)

* **æ±‡æ€»ä¿¡æ¯ï¼š**
  ```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ âœ… æ¸…ç†å®Œæˆ                      â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ å·²åˆ é™¤ï¼š15,234 ä¸ªæ–‡ä»¶            â”‚
  â”‚ å¤±è´¥ï¼š3 ä¸ªæ–‡ä»¶                   â”‚
  â”‚ é‡Šæ”¾ç©ºé—´ï¼š7.3 GB                 â”‚
  â”‚ è€—æ—¶ï¼š45 ç§’                      â”‚
  â”‚                                 â”‚
  â”‚ [æŸ¥çœ‹è¯¦æƒ…] [å®Œæˆ]               â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ```
* **å¤±è´¥æ–‡ä»¶è¯¦æƒ…ï¼š** åˆ—è¡¨æ˜¾ç¤ºå¤±è´¥åŸå› ï¼ˆæƒé™ä¸è¶³ã€æ–‡ä»¶è¢«å ç”¨ç­‰ï¼‰

---

## 5. å®‰å…¨ä¸æƒé™ç­–ç•¥ (Safety & Security)

### 5.1 UAC æƒé™ç®¡ç†

**5.1.1 åŒæ¨¡å¼è®¾è®¡**

| æ¨¡å¼ | æƒé™è¦æ±‚ | å¯æ¸…ç†èŒƒå›´ | æç¤ºæ–¹å¼ |
|------|---------|-----------|---------|
| **æ ‡å‡†æ¨¡å¼** | æ™®é€šç”¨æˆ· | ç”¨æˆ·ä¸´æ—¶æ–‡ä»¶ã€æµè§ˆå™¨ç¼“å­˜ | å¯åŠ¨æ—¶æ˜ç¡®æç¤º |
| **é«˜çº§æ¨¡å¼** | ç®¡ç†å‘˜ | å®Œæ•´æ‰«æï¼ˆå«ç³»ç»Ÿä¸´æ—¶æ–‡ä»¶ã€æ›´æ–°ç¼“å­˜ï¼‰ | å¯åŠ¨æ—¶æ˜ç¡®æç¤º |

**5.1.2 å¯åŠ¨æ—¶æç¤º**

* **æ ‡å‡†æ¨¡å¼å¯åŠ¨ï¼š**
  ```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ â„¹ï¸ å½“å‰ä¸ºæ ‡å‡†æ¨¡å¼                â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ å¯æ¸…ç†å†…å®¹ï¼š                     â”‚
  â”‚   âœ“ ç”¨æˆ·ä¸´æ—¶æ–‡ä»¶                 â”‚
  â”‚   âœ“ æµè§ˆå™¨ç¼“å­˜                   â”‚
  â”‚                                 â”‚
  â”‚ ä¸å¯æ¸…ç†ï¼š                       â”‚
  â”‚   âœ— ç³»ç»Ÿä¸´æ—¶æ–‡ä»¶ (éœ€ç®¡ç†å‘˜)      â”‚
  â”‚   âœ— Windows æ›´æ–°ç¼“å­˜ (éœ€ç®¡ç†å‘˜)  â”‚
  â”‚                                 â”‚
  â”‚ å»ºè®®ï¼šå…³é—­æ­¤çª—å£ï¼Œå³é”®é€‰æ‹©"ä»¥    â”‚
  â”‚ ç®¡ç†å‘˜èº«ä»½è¿è¡Œ"ä»¥å¯ç”¨å®Œæ•´æ‰«æ    â”‚
  â”‚                                 â”‚
  â”‚ [ç»§ç»­æ ‡å‡†æ¨¡å¼]                  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ```

* **é«˜çº§æ¨¡å¼å¯åŠ¨ï¼š**
  ```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ğŸ›¡ï¸ é«˜çº§æ¨¡å¼å·²å¯ç”¨                â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ å½“å‰å…·å¤‡ç®¡ç†å‘˜æƒé™ï¼Œå¯æ‰«æï¼š      â”‚
  â”‚   âœ“ ç³»ç»Ÿä¸´æ—¶æ–‡ä»¶                 â”‚
  â”‚   âœ“ Windows æ›´æ–°ç¼“å­˜             â”‚
  â”‚   âœ“ å›æ”¶ç«™                       â”‚
  â”‚                                 â”‚
  â”‚ [å¼€å§‹æ‰«æ]                      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ```

**5.1.3 æƒé™é™çº§ç­–ç•¥**

```python
def detect_admin_mode():
    """æ£€æµ‹ç®¡ç†å‘˜æƒé™"""
    import ctypes
    try:
        return ctypes.windll.shell32.IsUserAnAdmin()
    except:
        return False

def main():
    is_admin = detect_admin_mode()

    if not is_admin:
        # æ˜¾ç¤ºæ ‡å‡†æ¨¡å¼æç¤º
        show_standard_mode_warning()
        mode = "standard"
    else:
        # æ˜¾ç¤ºé«˜çº§æ¨¡å¼æç¤º
        show_advanced_mode_warning()
        mode = "advanced"

    # åœ¨ UI ä¸»ç•Œé¢æ˜¾ç¤ºå½“å‰æ¨¡å¼æŒ‡ç¤ºå™¨
    ui.set_mode_indicator(mode)
```

### 5.2 å¤šå±‚é˜²æŠ¤æœºåˆ¶ *[ä¿®è®¢]*

**ç¬¬ä¸€å±‚ï¼šç¡¬ç¼–ç ä¿æŠ¤ï¼ˆä¸å¯ç¯¡æ”¹ï¼‰**

```python
HARDCODED_PROTECTED = [
    "C:\\Windows",
    "C:\\Program Files",
    "C:\\Program Files (x86)",
]
```

**ç¬¬äºŒå±‚ï¼šé…ç½®æ–‡ä»¶ç™½åå•**

```json
{
  "protected_paths": ["C:\\Windows\\System32"],
  "whitelist_extensions": [".docx", ".xlsx", ".pdf"]
}
```

**ç¬¬ä¸‰å±‚ï¼šè¿è¡Œæ—¶åŠ¨æ€æ£€æŸ¥**

* ç¬¦å·é“¾æ¥è§£æï¼š`os.path.realpath()`
* ç³»ç»Ÿæ–‡ä»¶å±æ€§æ£€æµ‹ï¼š`os.stat()` çš„ `st_file_attributes`
* çœŸå®æ‰©å±•åæ£€æµ‹ï¼šé€šè¿‡æ–‡ä»¶é­”æ•°è¯†åˆ«

### 5.3 å›æ”¶ç«™å®¹é‡ç®¡ç†

**é—®é¢˜ï¼š** Windows å›æ”¶ç«™é»˜è®¤å®¹é‡ä¸º C ç›˜çš„ 10%ï¼Œæ¸…ç†å¤§é‡æ•°æ®æ—¶å¯èƒ½æº¢å‡ºã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

```python
def safe_send2trash(path):
    """æ£€æŸ¥å›æ”¶ç«™å®¹é‡åå†åˆ é™¤"""

    # ä¼°ç®—å›æ”¶ç«™å‰©ä½™å®¹é‡
    recycle_bin_size = get_recycle_bin_size()
    file_size = get_folder_size(path)

    if file_size > recycle_bin_size:
        # æä¾›é€‰é¡¹
        choice = ask_user(
            f"æ–‡ä»¶ {file_size/GB:.1f}GB è¶…è¿‡å›æ”¶ç«™å‰©ä½™å®¹é‡\n"
            f"å›æ”¶ç«™å¯ç”¨ï¼š{recycle_bin_size/GB:.1f}GB",
            options=[
                "åˆ†æ‰¹åˆ é™¤ï¼ˆæ¨èï¼‰",
                "æ°¸ä¹…åˆ é™¤ï¼ˆä¸å¯æ¢å¤ï¼‰",
                "å–æ¶ˆ"
            ]
        )

        if choice == "åˆ†æ‰¹åˆ é™¤":
            delete_in_batches(path, batch_size=recycle_bin_size // 2)
        elif choice == "æ°¸ä¹…åˆ é™¤":
            permanent_delete(path)  # ä½¿ç”¨ shutil.rmtree
        else:
            return False
    else:
        send2trash(path)

    return True
```

### 5.4 å¼‚å¸¸å¤„ç†ç­–ç•¥

| å¼‚å¸¸ç±»å‹ | æ•è·ä½ç½® | å¤„ç†ç­–ç•¥ | æ—¥å¿—è®°å½• |
|---------|---------|---------|---------|
| `PermissionError` | æ‰«æ/åˆ é™¤ | è·³è¿‡ï¼Œç»§ç»­ | âš ï¸ Warning |
| `OSError` (æ–‡ä»¶è¢«å ç”¨) | åˆ é™¤ | è·³è¿‡ï¼Œç»§ç»­ | âš ï¸ Warning |
| `FileNotFoundError` | æ‰«æ | å¿½ç•¥ï¼ˆæ–‡ä»¶å·²åˆ é™¤ï¼‰ | â„¹ï¸ Info |
| `SecurityError` | åˆ é™¤ | ä¸­æ­¢ï¼Œå¼¹çª—æç¤º | ğŸš¨ Critical |
| `UnicodeDecodeError` | æ‰«æ | è·³è¿‡ï¼ˆæ–‡ä»¶åç¼–ç é—®é¢˜ï¼‰ | âš ï¸ Warning |

---

## 6. æ€§èƒ½ä¼˜åŒ–è®¾è®¡ (Performance Optimization)

### 6.1 æ‰«ææ€§èƒ½ä¼˜åŒ–

**6.1.1 Windows API ä¼˜åŒ–æ–¹æ¡ˆ**

```python
import ctypes
from ctypes import wintypes

kernel32 = ctypes.windll.kernel32

def get_folder_size_fast(path):
    """ä½¿ç”¨ Win32 API å¿«é€Ÿè®¡ç®—æ–‡ä»¶å¤¹å¤§å°"""
    total_size = ctypes.c_ulonglong(0)

    # ä½¿ç”¨ FindFirstFile/FindNextFile éå†
    # æ€§èƒ½æ¯” Python os.walk å¿« 5-10 å€
    # ï¼ˆå…·ä½“å®ç°ç•¥ï¼Œå‚è§é™„å½•ï¼‰

    return total_size.value
```

**6.1.2 å¹¶å‘æ‰«æç­–ç•¥**

é’ˆå¯¹å¤šä¸ªç‹¬ç«‹ç›®å½•ï¼ˆå¦‚ Program Files å’Œ AppDataï¼‰ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¹¶å‘æ‰«æï¼š

```python
from concurrent.futures import ThreadPoolExecutor

def parallel_scan(paths, max_workers=4):
    """å¹¶å‘æ‰«æå¤šä¸ªç‹¬ç«‹è·¯å¾„"""
    with ThreadPoolExecutor(max_workers=max_workers) as executor:
        futures = [executor.submit(scan_single_path, p) for p in paths]
        results = [f.result() for f in futures]
    return merge_results(results)
```

**6.1.3 æ‰«æç¼“å­˜æœºåˆ¶**

```python
class ScanCache:
    """æ‰«æç»“æœç¼“å­˜ï¼ˆç¬¬äºŒæ¬¡æ‰«æç§’çº§å“åº”ï¼‰"""

    def __init__(self, cache_file="scan_cache.json"):
        self.cache_file = cache_file
        self.cache = self.load_cache()

    def load_cache(self):
        """åŠ è½½ç¼“å­˜"""
        if os.path.exists(self.cache_file):
            with open(self.cache_file) as f:
                return json.load(f)
        return {}

    def save_cache(self):
        """ä¿å­˜ç¼“å­˜"""
        with open(self.cache_file, 'w') as f:
            json.dump(self.cache, f)

    def get_cached_size(self, path):
        """è·å–ç¼“å­˜çš„å¤§å°ï¼ˆæœ‰æ•ˆæœŸ 1 å°æ—¶ï¼‰"""
        if path in self.cache:
            entry = self.cache[path]
            if time.time() - entry['timestamp'] < 3600:
                return entry['size']
        return None
```

### 6.2 å†…å­˜ç®¡ç†ä¼˜åŒ–

**6.2.1 æµå¼å¤„ç†ï¼ˆé¿å…å†…å­˜æº¢å‡ºï¼‰**

```python
def scan_stream():
    """ç”Ÿæˆå™¨æ¨¡å¼ï¼Œæµå¼è¿”å›æ‰«æç»“æœ"""
    for folder in scan_targets:
        size = calculate_size(folder)
        yield AppCluster(folder, size)

# UI ç«¯åˆ†æ‰¹åŠ è½½ï¼ˆæ¯é¡µ 20 æ¡ï¼‰
def load_page(page_num, items_per_page=20):
    start = page_num * items_per_page
    end = start + items_per_page
    return itertools.islice(scan_stream(), start, end)
```

**6.2.2 å¤§æ–‡ä»¶å¤„ç†**

å¯¹äºè¶…å¤§æ–‡ä»¶ï¼ˆ>1GBï¼‰ï¼Œä»…è®°å½•å…ƒæ•°æ®ï¼Œä¸å®Œæ•´è¯»å–ï¼š

```python
def handle_large_file(path):
    """å¤§æ–‡ä»¶å¤„ç†ç­–ç•¥"""
    size = os.path.getsize(path)
    if size > 1_000_000_000:  # > 1GB
        # ä»…è®°å½•è·¯å¾„å’Œå¤§å°ï¼Œä¸è¯»å–å†…å®¹
        return {
            "path": path,
            "size": size,
            "type": "large_file",
            "action": "å»ºè®®äººå·¥æ£€æŸ¥"
        }
```

### 6.3 è§„åˆ™åŒ¹é…ä¼˜åŒ–

ä½¿ç”¨å‰ç¼€æ ‘ï¼ˆTrieï¼‰åŠ é€Ÿè·¯å¾„åŒ¹é…ï¼š

```python
class PathTrie:
    """è·¯å¾„å‰ç¼€æ ‘"""

    def __init__(self):
        self.children = {}
        self.rules = []

    def insert(self, path, rule):
        """æ’å…¥è·¯å¾„è§„åˆ™"""
        node = self
        for part in path.split(os.sep):
            if part not in node.children:
                node.children[part] = PathTrie()
            node = node.children[part]
        node.rules.append(rule)

    def search(self, path):
        """æœç´¢åŒ¹é…è§„åˆ™"""
        node = self
        for part in path.split(os.sep):
            if part not in node.children:
                break
            node = node.children[part]
        return node.rules
```

---

## 7. è¾¹ç•Œæƒ…å†µå¤„ç† (Edge Cases)

### 7.1 ç‰¹æ®Šæ–‡ä»¶ç±»å‹

| æ–‡ä»¶ç±»å‹ | å¤„ç†ç­–ç•¥ | è¯´æ˜ |
|---------|---------|------|
| **åªè¯»æ–‡ä»¶** | ç§»é™¤åªè¯»å±æ€§ååˆ é™¤ | ä½¿ç”¨ `os.chmod(path, 0o777)` |
| **éšè—æ–‡ä»¶** | æ­£å¸¸å¤„ç† | æ£€æŸ¥ `FILE_ATTRIBUTE_HIDDEN` |
| **ç³»ç»Ÿæ–‡ä»¶** | ç¦æ­¢åˆ é™¤ | æ£€æŸ¥ `FILE_ATTRIBUTE_SYSTEM` |
| **ç¬¦å·é“¾æ¥** | è§£æåæ£€æŸ¥ç›®æ ‡ | ä½¿ç”¨ `os.path.realpath()` |
| ** Junctions** | è·³è¿‡ï¼ˆä¸è·Ÿéšï¼‰ | é¿å…å¾ªç¯å¼•ç”¨ |
| **è¶…é•¿è·¯å¾„** | ä½¿ç”¨ `\\?\` å‰ç¼€ | Windows 260 å­—ç¬¦é™åˆ¶ |

### 7.2 ç‰¹æ®Šç›®å½•

| ç›®å½•ç±»å‹ | å¤„ç†ç­–ç•¥ | è¯´æ˜ |
|---------|---------|------|
| **å›æ”¶ç«™** | ç®¡ç†å‘˜æ¨¡å¼å¯æ¸…ç©º | `C:\$Recycle.Bin` |
| **ç³»ç»Ÿå·ä¿¡æ¯** | ç¦æ­¢è®¿é—® | `C:\System Volume Information` |
| **WSL ç›®å½•** | æ ‡è®°ä¸ºç‰¹æ®Š | `C:\Users\xxx\AppData\Local\Packages\...` |
| **OneDrive ç¼“å­˜** | éœ€ç”¨æˆ·ç¡®è®¤ | é¿å…åˆ é™¤äº‘åŒæ­¥æ•°æ® |

### 7.3 å›½é™…åŒ–æ”¯æŒ

**7.3.1 ä¸­æ–‡è·¯å¾„å¤„ç†**

```python
# ç¡®ä¿æ‰€æœ‰æ–‡ä»¶æ“ä½œä½¿ç”¨ Unicode
import sys
import locale

# è®¾ç½®æ ‡å‡†è¾“å‡ºç¼–ç 
if sys.platform == 'win32':
    sys.stdout.reconfigure(encoding='utf-8')
```

**7.3.2 å¤šè¯­è¨€ UIï¼ˆé¢„ç•™ï¼‰**

```python
# ä½¿ç”¨ gettext å®ç°å›½é™…åŒ–
import gettext
zh_CN = gettext.translation('cwiper', localedir='locales', languages=['zh_CN'])
zh_CN.install()
_ = zh_CN.gettext

# UI ä¸­ä½¿ç”¨
ui.label.setText(_("Start Analysis"))
```

---

## 8. å¼€å‘è·¯çº¿å›¾ (Roadmap) *[è°ƒæ•´]*

### 8.1 é˜¶æ®µåˆ’åˆ†

| é˜¶æ®µ | ç›®æ ‡ | å…³é”®åŠŸèƒ½ç‚¹ | é¢„ä¼°å‘¨æœŸ | éªŒæ”¶æ ‡å‡† |
|------|------|-----------|---------|---------|
| **Phase 1: MVP** | **å¯ç”¨æ€§éªŒè¯** | â€¢ åŸºç¡€ UIï¼ˆTkinterï¼‰<br>â€¢ `send2trash` é›†æˆ<br>â€¢ æ‰«æ `%TEMP%` ç›®å½•<br>â€¢ åˆ—è¡¨å±•ç¤º + åˆ é™¤ | **1-2 å‘¨** | â€¢ èƒ½æ‰«æå¹¶åˆ—å‡ºä¸´æ—¶æ–‡ä»¶<br>â€¢ æ˜¾ç¤ºæ€»å¤§å°<br>â€¢ èƒ½å°†é€‰ä¸­æ–‡ä»¶ç§»è‡³å›æ”¶ç«™<br>â€¢ å¼‚å¸¸å¤„ç†å®Œæ•´ |
| **Phase 2: æ ¸å¿ƒå¢å¼º** | **è§„åˆ™ä¸åˆ†æ** | â€¢ JSON è§„åˆ™å¼•æ“<br>â€¢ **AppAnalyzer æ¨¡å—**<br>â€¢ ä¸‰çº§é£é™©åˆ†çº§<br>â€¢ æ™ºèƒ½åŒ¹é…ç®—æ³• | **3-4 å‘¨** | â€¢ è§„åˆ™å¼•æ“åŠ è½½å¹¶åŒ¹é…<br>â€¢ é£é™©åˆ†çº§æ­£ç¡®æ˜¾ç¤ºé¢œè‰²<br>â€¢ AppAnalyzer è¯†åˆ« â‰¥5 ä¸ªå¸¸è§åº”ç”¨<br>â€¢ æµ‹è¯•è¦†ç›–ç‡ >70% |
| **Phase 3: ä½“éªŒä¼˜åŒ–** | **äº¤äº’ä¸åˆ†å‘** | â€¢ å¤šçº¿ç¨‹é˜²å¡æ­»<br>â€¢ UI ç¾åŒ– (CustomTkinter)<br>â€¢ Nuitka æ‰“åŒ…ä¼˜åŒ–<br>â€¢ æ‰«æè¿›åº¦å®æ—¶æ˜¾ç¤º | **2-3 å‘¨** | â€¢ æ‰«æä¸é˜»å¡ UI<br>â€¢ å•æ–‡ä»¶ä½“ç§¯ <30MB<br>â€¢ 5 å¹´æ—§ç”µè„‘å¯åŠ¨æ—¶é—´ <3 ç§’ |
| **Phase 4: å®ç”¨å¢å¼º** | **é«˜ä»·å€¼åŠŸèƒ½** | â€¢ ç©ºæ–‡ä»¶å¤¹æ¸…ç†<br>â€¢ å¤§æ–‡ä»¶ TOP100 åˆ—è¡¨<br>â€¢ æ¸…ç†å†å²è®°å½•<br>â€¢ è§„åˆ™åº“çƒ­é‡è½½ | **2-3 å‘¨** | â€¢ èƒ½è¯†åˆ«å¹¶æ¸…ç†ç©ºæ–‡ä»¶å¤¹<br>â€¢ å¤§æ–‡ä»¶åˆ—è¡¨æ­£ç¡®æ’åº<br>â€¢ å†å²è®°å½•æŒä¹…åŒ– |
| **Phase 5: å¯é€‰æ‰©å±•** | **æŒ‰éœ€å¼€å‘** | â€¢ å¤šè¯­è¨€æ”¯æŒ<br>â€¢ ä¾¿æºç‰ˆ + å®‰è£…ç‰ˆ<br>â€¢ æ’ä»¶ç³»ç»Ÿ<br>â€¢ è‡ªåŠ¨æ›´æ–°è§„åˆ™åº“ | **2-4 å‘¨** | â€¢ æ ¹æ®éœ€æ±‚ä¼˜å…ˆçº§å¼€å‘ |

**æ€»å‘¨æœŸï¼š10-16 å‘¨ï¼ˆå•äººå¼€å‘ï¼‰**

### 8.2 å…³é”®é‡Œç¨‹ç¢‘

**Milestone 1 (Phase 1 å®Œæˆ):**
- âœ… MVP å¯æ¼”ç¤º
- âœ… éªŒè¯æ ¸å¿ƒä»·å€¼ï¼ˆå®‰å…¨åˆ é™¤ï¼‰

**Milestone 2 (Phase 2 å®Œæˆ):**
- âœ… AppAnalyzer å¯ç”¨
- âœ… å·®å¼‚åŒ–åŠŸèƒ½å®ç°

**Milestone 3 (Phase 3 å®Œæˆ):**
- âœ… é¦–ä¸ªå…¬å¼€ç‰ˆæœ¬ v1.0
- âœ… å¯åˆ†å‘ç»™æµ‹è¯•ç”¨æˆ·

**Milestone 4 (Phase 4 å®Œæˆ):**
- âœ… ç¨³å®šç‰ˆæœ¬ v1.5
- âœ… åŠŸèƒ½å®Œæ•´ï¼Œå¯æ­£å¼å‘å¸ƒ

### 8.3 æŠ€æœ¯å€ºåŠ¡ç®¡ç†

| å€ºåŠ¡ç±»å‹ | ä¼˜å…ˆçº§ | è®¡åˆ’å¿è¿˜æ—¶é—´ |
|---------|-------|-------------|
| å›½é™…åŒ–æ”¯æŒ | ä½ | Phase 5 |
| å•å…ƒæµ‹è¯•è¦†ç›– | ä¸­ | Phase 2 æŒç»­è¡¥å…… |
| æ€§èƒ½ä¼˜åŒ–ï¼ˆWindows APIï¼‰ | ä¸­ | Phase 3 |
| æ’ä»¶ç³»ç»Ÿ | ä½ | Phase 5 |

---

## 9. æµ‹è¯•ç­–ç•¥ (Testing Strategy)

### 9.1 æµ‹è¯•é‡‘å­—å¡”

```
        /\
       /  \        E2E Tests (10%)
      /    \       - å®Œæ•´å·¥ä½œæµæµ‹è¯•
     /------\      - è·¨ç‰ˆæœ¬å…¼å®¹æ€§
    /        \     - çœŸå®ç¯å¢ƒéªŒè¯
   /          \
  / Integration \  Integration Tests (30%)
 /   Tests      \ - æ¨¡å—é—´äº¤äº’
/----------------\ - è§„åˆ™å¼•æ“æµ‹è¯•
   Unit Tests (60%)
   - å•ä¸ªå‡½æ•°æµ‹è¯•
   - è¾¹ç•Œæ¡ä»¶æµ‹è¯•
   - å¼‚å¸¸å¤„ç†æµ‹è¯•
```

### 9.2 å…³é”®æµ‹è¯•ç”¨ä¾‹

**9.2.1 å®‰å…¨æµ‹è¯•**

| æµ‹è¯•ç”¨ä¾‹ | è¾“å…¥ | é¢„æœŸè¾“å‡º |
|---------|------|---------|
| ç¬¦å·é“¾æ¥æ”»å‡» | `malicious -> C:\Windows\System32` | âŒ æ‹’ç»åˆ é™¤ |
| ä¿®æ”¹è§„åˆ™åº“ | ç¯¡æ”¹ `protected_paths` | âŒ ç¡¬ç¼–ç ä¿æŠ¤ä»ç”Ÿæ•ˆ |
| å›æ”¶ç«™æº¢å‡º | æ¸…ç† >å›æ”¶ç«™å®¹é‡ | âš ï¸ æç¤ºåˆ†æ‰¹åˆ é™¤ |
| åªè¯»æ–‡ä»¶ | `readonly.dat` | âœ… ç§»é™¤åªè¯»å±æ€§ååˆ é™¤ |

**9.2.2 åŠŸèƒ½æµ‹è¯•**

| æµ‹è¯•ç”¨ä¾‹ | è¾“å…¥ | é¢„æœŸè¾“å‡º |
|---------|------|---------|
| AppAnalyzer åŒ¹é… | Static: `Tencent`, Dynamic: `Tencent\WeChat Files` | âœ… è¯†åˆ«ä¸ºåŒä¸€åº”ç”¨ |
| è§„åˆ™åŒ¹é… | æ–‡ä»¶ï¼š`C:\temp\test.tmp` | âœ… åŒ¹é… L1 (Safe) |
| UAC é™çº§ | æ™®é€šç”¨æˆ·æƒé™ | âš ï¸ æ˜¾ç¤ºæ ‡å‡†æ¨¡å¼æç¤º |
| æ‰«æå–æ¶ˆ | æ‰«æä¸­ç‚¹å‡»å–æ¶ˆ | âœ… åœæ­¢æ‰«æï¼Œæ˜¾ç¤ºå·²å‘ç°å†…å®¹ |

### 9.3 æ€§èƒ½æµ‹è¯•

| æµ‹è¯•åœºæ™¯ | æ€§èƒ½æŒ‡æ ‡ |
|---------|---------|
| æ‰«æ 100,000 ä¸ªæ–‡ä»¶ | < 60 ç§’ |
| å¯åŠ¨æ—¶é—´ | < 3 ç§’ï¼ˆ5 å¹´æ—§ç”µè„‘ï¼‰ |
| å†…å­˜å ç”¨ | < 200 MBï¼ˆæ‰«æä¸­ï¼‰ |
| UI å“åº”æ—¶é—´ | < 100 msï¼ˆæ‰«æä¸­ï¼‰ |

---

## 10. éƒ¨ç½²ä¸åˆ†å‘ (Deployment)

### 10.1 æ„å»ºæµç¨‹

```bash
# 1. å®‰è£… Nuitka
pip install nuitka

# 2. ç¼–è¯‘ä¸ºå•æ–‡ä»¶
python -m nuitka \
    --standalone \
    --onefile \
    --windows-disable-console \
    --windows-icon-from-ico=assets/icon.ico \
    --output-dir=dist \
    --output-filename=C-Wiper.exe \
    src/main.py

# 3. ç­¾åï¼ˆå¯é€‰ï¼‰
signtool sign /f certificate.pfx /p password dist/C-Wiper.exe
```

### 10.2 åˆ†å‘ç­–ç•¥

**ç‰ˆæœ¬ç®¡ç†ï¼š**
* **ç¨³å®šç‰ˆ (Stable):** æ¯æœˆå‘å¸ƒï¼Œç»è¿‡å……åˆ†æµ‹è¯•
* **æµ‹è¯•ç‰ˆ (Beta):** æ¯å‘¨å‘å¸ƒï¼ŒåŒ…å«æ–°åŠŸèƒ½
* **ä¾¿æºç‰ˆ (Portable):** å•æ–‡ä»¶ EXEï¼Œæ— éœ€å®‰è£…
* **å®‰è£…ç‰ˆ (Installer):** åŒ…å«å¸è½½ç¨‹åºã€å¼€å§‹èœå•å¿«æ·æ–¹å¼

**å‘å¸ƒæ¸ é“ï¼š**
* GitHub Releasesï¼ˆä¸»æ¸ é“ï¼‰
* è‡ªå»ºç½‘ç«™ï¼ˆå¯é€‰ï¼‰
* å›½å†…é•œåƒï¼ˆGitee ç­‰ï¼‰

### 10.3 æ›´æ–°æœºåˆ¶

**æ–¹æ¡ˆ Aï¼ˆæ¨èï¼‰ï¼š** æ£€æŸ¥ GitHub API
```python
import requests

def check_for_update(current_version):
    """æ£€æŸ¥ GitHub æœ€æ–°ç‰ˆæœ¬"""
    response = requests.get(
        "https://api.github.com/repos/yourname/cwiper/releases/latest"
    )
    latest = response.json()['tag_name']
    if latest > current_version:
        return latest, response.json()['html_url']
    return None
```

**æ–¹æ¡ˆ Bï¼ˆå¯é€‰ï¼‰ï¼š** å†…ç½®æ›´æ–°å™¨
* ä¸‹è½½æ–°ç‰ˆæœ¬
* æ ¡éªŒæ•°å­—ç­¾å
* è‡ªåŠ¨æ›¿æ¢å½“å‰ç¨‹åº

---

## 11. é™„å½• (Appendix)

### 11.1 å‚è€ƒèµ„æ–™

* [send2trash æ–‡æ¡£](https://github.com/arsenetar/send2trash)
* [Nuitka ç”¨æˆ·æŒ‡å—](https://nuitka.net/doc/user-manual.html)
* [Windows API æ–‡æ¡£](https://docs.microsoft.com/en-us/windows/win32/api/)
* [Tkinter å®˜æ–¹æ•™ç¨‹](https://docs.python.org/3/library/tkinter.html)

### 11.2 ç«å“åˆ†æ

| å·¥å…· | ä¼˜ç‚¹ | ç¼ºç‚¹ | C-Wiper å€Ÿé‰´ |
|------|------|------|-------------|
| **CCleaner** | åŠŸèƒ½å…¨é¢ã€ç”¨æˆ·åŸºæ•°å¤§ | ä½“ç§¯å¤§ã€æœ‰å¹¿å‘Šã€é—­æº | å®‰å…¨åˆ é™¤æœºåˆ¶ |
| **BleachBit** | å¼€æºã€æ— å¹¿å‘Š | UI ç®€é™‹ã€æ— å†³ç­–è¾…åŠ© | è§„åˆ™å¼•æ“è®¾è®¡ |
| **Storage Sense** | ç³»ç»Ÿé›†æˆ | åŠŸèƒ½å—é™ã€ä¸é€æ˜ | Windows ä¸´æ—¶è·¯å¾„åˆ—è¡¨ |
| **WizTree** | æ‰«ææå¿« | ä»…åˆ†æã€ä¸æ¸…ç† | å¿«é€Ÿæ‰«æç®—æ³• |

### 11.3 Windows API å¿«é€Ÿæ‰«æå®ç°ç¤ºä¾‹

```python
import ctypes
from ctypes import wintypes

kernel32 = ctypes.windll.kernel32

# å®šä¹‰ Windows ç»“æ„ä½“å’Œå¸¸é‡
class WIN32_FIND_DATAW(ctypes.Structure):
    _fields_ [
        ("dwFileAttributes", wintypes.DWORD),
        ("ftCreationTime", wintypes.FILETIME),
        ("ftLastAccessTime", wintypes.FILETIME),
        ("ftLastWriteTime", wintypes.FILETIME),
        ("nFileSizeHigh", wintypes.DWORD),
        ("nFileSizeLow", wintypes.DWORD),
        ("dwReserved0", wintypes.DWORD),
        ("dwReserved1", wintypes.DWORD),
        ("cFileName", wintypes.WCHAR * 260),
        ("cAlternateFileName", wintypes.WCHAR * 14),
    ]

def find_files_winapi(path):
    """ä½¿ç”¨ Windows API éå†æ–‡ä»¶ï¼ˆæ€§èƒ½ä¼˜åŒ–ç¤ºä¾‹ï¼‰"""
    find_data = WIN32_FIND_DATAW()
    h_find = kernel32.FindFirstFileW(path + "\\*", ctypes.byref(find_data))

    if h_find == wintypes.HANDLE(-1).value:
        return

    try:
        while True:
            filename = find_data.cFileName
            if filename not in (".", ".."):
                size = (find_data.nFileSizeHigh << 32) | find_data.nFileSizeLow
                is_dir = bool(find_data.dwFileAttributes & 0x10)
                yield filename, size, is_dir

            if not kernel32.FindNextFileW(h_find, ctypes.byref(find_data)):
                break
    finally:
        kernel32.FindClose(h_find)
```

### 11.4 æœ¯è¯­è¡¨

| æœ¯è¯­ | è¯´æ˜ |
|------|------|
| **é¶ç‚¹æ‰«æ** | é’ˆå¯¹å·²çŸ¥åƒåœ¾è·¯å¾„è¿›è¡Œç²¾å‡†æ‰«æï¼Œè€Œéå…¨ç›˜ç›²æ‰« |
| **TOCTOU** | Time-of-Check-Time-of-Useï¼Œæ£€æŸ¥ä¸ä½¿ç”¨ä¹‹é—´çš„æ—¶é—´å·®æ”»å‡» |
| **UAC** | User Account Controlï¼ŒWindows ç”¨æˆ·è´¦æˆ·æ§åˆ¶ |
| **AppData** | Windows åº”ç”¨æ•°æ®ç›®å½•ï¼ŒåŒ…å«ç”¨æˆ·çº§åº”ç”¨é…ç½®å’Œç¼“å­˜ |
| **å­¤å„¿æ•°æ®** | åº”ç”¨å·²å¸è½½ï¼Œä½†ç”¨æˆ·æ•°æ®ä»æ®‹ç•™çš„æƒ…å†µ |
| **Junction** | Windows ç›®å½•é“¾æ¥ï¼Œç±»ä¼¼äºç¬¦å·é“¾æ¥ä½†ä»…é€‚ç”¨äºç›®å½• |

---

## æ–‡æ¡£ä¿®è®¢è¯´æ˜

**V1.1 ä¸»è¦æ”¹è¿›ï¼š**

1. **å®‰å…¨å¢å¼ºï¼š**
   - æ–°å¢å¤šå±‚é˜²æŠ¤æœºåˆ¶è®¾è®¡
   - è¡¥å…… TOCTOU é˜²æŠ¤ï¼ˆç¬¦å·é“¾æ¥æ£€æµ‹ï¼‰
   - å¢åŠ å›æ”¶ç«™å®¹é‡ç®¡ç†

2. **ç®—æ³•ç»†åŒ–ï¼š**
   - è¯¦ç»†æè¿° AppMatcher æ™ºèƒ½åŒ¹é…ç®—æ³•
   - å¢åŠ åˆ«åæ˜ å°„å’Œæ¨¡ç³ŠåŒ¹é…æœºåˆ¶
   - ä¼˜åŒ–è§„åˆ™åŒ¹é…ç´¢å¼•è®¾è®¡

3. **æ¶æ„å®Œå–„ï¼š**
   - æ˜ç¡®çº¿ç¨‹åŒæ­¥æœºåˆ¶
   - è¡¥å…… Controller å±‚èŒè´£åˆ’åˆ†
   - å¢åŠ çŠ¶æ€ç®¡ç†å™¨è®¾è®¡

4. **è¾¹ç•Œæƒ…å†µï¼š**
   - æ–°å¢å®Œæ•´çš„è¾¹ç•Œæƒ…å†µå¤„ç†ç« èŠ‚
   - è¡¥å……ç‰¹æ®Šæ–‡ä»¶ç±»å‹å’Œç›®å½•çš„å¤„ç†ç­–ç•¥

5. **æ€§èƒ½ä¼˜åŒ–ï¼š**
   - å¢åŠ  Windows API ä¼˜åŒ–æ–¹æ¡ˆ
   - è¡¥å……æ‰«æç¼“å­˜æœºåˆ¶
   - å¢åŠ å†…å­˜ç®¡ç†ç­–ç•¥

6. **è·¯çº¿å›¾è°ƒæ•´ï¼š**
   - é‡æ–°åˆ’åˆ† Phase 4 å’Œ Phase 5
   - å¢åŠ æ˜ç¡®çš„éªŒæ”¶æ ‡å‡†
   - è¡¥å……å…³é”®é‡Œç¨‹ç¢‘å®šä¹‰

---

**æ–‡æ¡£ç»“æŸ**

*æœ¬æ–‡æ¡£ç”± Claude Sonnet 4.5 ååŠ©å®Œæˆï¼ŒåŸºäº v1.0 ç‰ˆæœ¬å’Œæ·±åº¦å®‰å…¨è¯„ä¼°æŠ¥å‘Šè¿›è¡Œä¿®è®¢ã€‚*
