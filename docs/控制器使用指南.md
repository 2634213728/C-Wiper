# C-Wiper 控制器快速使用指南

## 目录
1. [ScanController 使用](#1-scancontroller-使用)
2. [CleanController 使用](#2-cleancontroller-使用)
3. [AnalysisController 使用](#3-analysiscontroller-使用)
4. [完整示例](#4-完整示例)

---

## 1. ScanController 使用

### 初始化
```python
from src.controllers.scan_controller import ScanController
from src.models.scan_result import ScanTarget
from pathlib import Path

# 创建控制器
controller = ScanController()
```

### 启动扫描
```python
# 定义扫描目标
targets = [
    ScanTarget(
        id="temp_files",
        name="临时文件",
        path=Path("C:/Windows/Temp"),
        description="Windows 临时文件目录"
    ),
    ScanTarget(
        id="app_cache",
        name="应用缓存",
        path=Path.home() / "AppData" / "Local" / "Temp",
        description="应用程序临时缓存"
    )
]

# 启动扫描（后台执行）
if controller.start_scan(targets):
    print("扫描已启动")

# 等待完成
if controller.wait_for_completion(timeout=60):
    print("扫描完成")
```

### 获取结果
```python
# 获取扫描结果
results = controller.get_results()
for result in results:
    print(f"目标: {result.target.name}")
    print(f"  文件数: {result.file_count}")
    print(f"  总大小: {result.format_total_size()}")
    print(f"  耗时: {result.scan_duration:.2f}s")

# 获取匹配的文件
l1_files = controller.get_matched_files("L1_SAFE")  # 安全文件
l2_files = controller.get_matched_files("L2_REVIEW")  # 需审查文件

print(f"L1 安全文件: {len(l1_files)} 个")
print(f"L2 审查文件: {len(l2_files)} 个")

# 获取扫描摘要
summary = controller.get_scan_summary()
print(f"总文件数: {summary['total_files']}")
print(f"释放空间潜力: {summary['L1_SAFE']} 个文件")
```

### 取消扫描
```python
# 检查是否正在扫描
if controller.is_scanning():
    # 取消扫描
    controller.cancel_scan()
    print("扫描已取消")
```

---

## 2. CleanController 使用

### 初始化
```python
from src.controllers.clean_controller import CleanController

# 创建控制器
controller = CleanController()
```

### 预览清理
```python
# 从扫描控制器获取文件
from src.controllers.scan_controller import ScanController

scan_controller = ScanController()
# ... 执行扫描 ...

l1_files = scan_controller.get_matched_files("L1_SAFE")

# 预览清理
preview = controller.preview_clean(l1_files)
print(f"将删除 {preview['file_count']} 个文件")
print(f"释放空间: {preview['formatted_size']}")
print(f"安全文件: {preview['safe_files']}")
print(f"需审查文件: {preview['risky_files']}")

if preview['recycle_bin_warning']:
    print(f"警告: 回收站使用率 {preview['recycle_bin_usage']}")
```

### 执行清理
```python
# 第一步：确认清理
controller.confirm_clean()

# 第二步：启动清理
if controller.start_clean(l1_files):
    print("清理已启动")

# 第三步：等待完成
if controller.wait_for_completion(timeout=60):
    print("清理完成")

# 第四步：获取报告
report = controller.get_report()
if report:
    print(f"已删除: {report['files_deleted']} 个文件")
    print(f"释放空间: {report['formatted_size']}")
    print(f"耗时: {report['duration']:.2f}s")
    print(f"跳过: {report['skipped']} 个文件")
```

### 取消清理
```python
if controller.is_cleaning():
    controller.cancel_clean()
    print("清理已取消")

# 重置确认状态（用于下次清理）
controller.reset_confirmation()
```

---

## 3. AnalysisController 使用

### 初始化
```python
from src.controllers.analysis_controller import AnalysisController

# 创建控制器
controller = AnalysisController()
```

### 启动分析
```python
# 启动应用空间分析（后台执行）
if controller.start_analysis():
    print("分析已启动")

# 等待完成（可能需要 10-30 秒）
if controller.wait_for_completion(timeout=60):
    print("分析完成")
```

### 获取结果
```python
# 获取应用簇列表
clusters = controller.get_clusters()
print(f"发现 {len(clusters)} 个应用")

# 显示前 10 个应用
for cluster in clusters[:10]:
    print(f"应用: {cluster.app_name}")
    print(f"  路径: {cluster.install_path}")
    print(f"  大小: {cluster._format_size(cluster.total_size)}")
    print(f"  静态文件: {len(cluster.static_files)}")
    print(f"  动态文件: {len(cluster.dynamic_files)}")

# 获取 Top 应用
top_apps = controller.get_top_apps(limit=5)
print("\n占用空间最大的应用:")
for app in top_apps:
    print(f"  {app['name']}: {app['formatted_size']}")
```

### 获取报告
```python
# 获取分析报告
report = controller.get_report()
if report:
    print(f"应用总数: {report['app_count']}")
    print(f"总大小: {report['formatted_size']}")
    print(f"总文件数: {report['total_files']}")
    print(f"分析耗时: {report['duration']:.2f}s")

    print("\nTop 应用:")
    for app in report['top_apps']:
        print(f"  - {app['name']}: {app['formatted_size']}")
```

### 取消分析
```python
if controller.is_analyzing():
    controller.cancel_analysis()
    print("分析已取消")
```

---

## 4. 完整示例

### 示例：扫描并清理临时文件

```python
import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).parent.parent))

from src.controllers.scan_controller import ScanController
from src.controllers.clean_controller import CleanController
from src.models.scan_result import ScanTarget

def main():
    print("=" * 60)
    print("C-Wiper 快速清理工具")
    print("=" * 60)

    # 步骤 1: 扫描
    print("\n[步骤 1] 扫描临时文件...")

    scan_controller = ScanController()

    targets = [
        ScanTarget(
            id="temp",
            name="Windows 临时文件",
            path=Path("C:/Windows/Temp")
        )
    ]

    if not scan_controller.start_scan(targets):
        print("错误: 无法启动扫描")
        return

    print("扫描中...")
    if not scan_controller.wait_for_completion(timeout=30):
        print("扫描超时")
        return

    print("扫描完成")

    # 步骤 2: 查看结果
    print("\n[步骤 2] 扫描结果:")

    summary = scan_controller.get_scan_summary()
    print(f"  总文件数: {summary['total_files']}")
    print(f"  L1 安全: {summary['L1_SAFE']}")
    print(f"  L2 审查: {summary['L2_REVIEW']}")

    # 步骤 3: 预览清理
    print("\n[步骤 3] 预览清理:")

    clean_controller = CleanController()
    l1_files = scan_controller.get_matched_files("L1_SAFE")

    if not l1_files:
        print("没有需要清理的文件")
        return

    preview = clean_controller.preview_clean(l1_files)
    print(f"  将删除: {preview['file_count']} 个文件")
    print(f"  释放空间: {preview['formatted_size']}")

    # 步骤 4: 确认并清理
    print("\n[步骤 4] 执行清理...")

    clean_controller.confirm_clean()

    if not clean_controller.start_clean(l1_files):
        print("错误: 无法启动清理")
        return

    if not clean_controller.wait_for_completion(timeout=30):
        print("清理超时")
        return

    print("清理完成")

    # 步骤 5: 查看报告
    print("\n[步骤 5] 清理报告:")

    report = clean_controller.get_report()
    if report:
        print(f"  已删除: {report['files_deleted']} 个文件")
        print(f"  释放空间: {report['formatted_size']}")
        print(f"  耗时: {report['duration']:.2f}s")

    print("\n" + "=" * 60)
    print("清理完成!")
    print("=" * 60)

if __name__ == "__main__":
    main()
```

### 示例：应用空间分析

```python
import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).parent.parent))

from src.controllers.analysis_controller import AnalysisController

def main():
    print("=" * 60)
    print("C-Wiper 应用空间分析")
    print("=" * 60)

    # 启动分析
    print("\n正在分析应用空间...")
    controller = AnalysisController()

    if not controller.start_analysis():
        print("错误: 无法启动分析")
        return

    if not controller.wait_for_completion(timeout=60):
        print("分析超时")
        return

    print("分析完成")

    # 显示结果
    report = controller.get_report()
    if report:
        print(f"\n应用总数: {report['app_count']}")
        print(f"总大小: {report['formatted_size']}")
        print(f"分析耗时: {report['duration']:.2f}s")

        print("\nTop 10 应用:")
        for i, app in enumerate(report['top_apps'][:10], 1):
            print(f"  {i}. {app['name']}: {app['formatted_size']}")

    print("\n" + "=" * 60)

if __name__ == "__main__":
    main()
```

---

## 常见问题

### Q: 如何检查当前状态？
```python
from src.controllers.state_manager import StateManager

state_manager = StateManager()
print(f"当前状态: {state_manager.current_state.value}")

# 检查方法
state_manager.is_idle()      # 是否空闲
state_manager.is_scanning()  # 是否正在扫描
state_manager.is_cleaning()  # 是否正在清理
state_manager.is_analyzing() # 是否正在分析
```

### Q: 如何处理取消操作？
```python
# 所有控制器都支持取消
scan_controller.cancel_scan()
clean_controller.cancel_clean()
analysis_controller.cancel_analysis()

# 检查取消状态
from src.controllers.state_manager import StateManager
state_manager = StateManager()

if state_manager.is_cancel_requested:
    print("操作已被取消")
```

### Q: 如何订阅事件？
```python
from src.utils.event_bus import EventBus, EventType

event_bus = EventBus()

def on_scan_completed(event):
    print(f"扫描完成: {event.data}")

event_bus.subscribe(EventType.SCAN_COMPLETED, on_scan_completed)
```

---

## 性能提示

1. **扫描大目录时**
   - 使用后台扫描避免阻塞
   - 设置合理的超时时间
   - 监控进度事件

2. **清理大量文件时**
   - 先预览再执行
   - 检查回收站容量
   - 分批处理大量文件

3. **分析应用时**
   - 分析可能需要 10-30 秒
   - 建议在后台执行
   - 缓存结果避免重复分析

---

**文档版本：** v1.0
**最后更新：** 2026-01-31
